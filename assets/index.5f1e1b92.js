import{r as e,a as t}from"./vendor.de62f314.js";!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const a=new URL(e,location),r=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,o)=>{const l=new URL(e,a);if(self[t].moduleMap[l])return n(self[t].moduleMap[l]);const i=new Blob([`import * as m from '${l}';`,`${t}.moduleMap['${l}']=m;`],{type:"text/javascript"}),s=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(i),onerror(){o(new Error(`Failed to import: ${e}`)),r(s)},onload(){n(self[t].moduleMap[l]),r(s)}});document.head.appendChild(s)})),self[t].moduleMap={}}}("assets/");const n=function(){const e=[[0,0,3,255],[0,0,4,255],[0,0,6,255],[1,0,7,255],[1,1,9,255],[1,1,11,255],[2,1,14,255],[2,2,16,255],[3,2,18,255],[4,3,20,255],[4,3,22,255],[5,4,24,255],[6,4,27,255],[7,5,29,255],[8,6,31,255],[9,6,33,255],[10,7,35,255],[11,7,38,255],[13,8,40,255],[14,8,42,255],[15,9,45,255],[16,9,47,255],[18,10,50,255],[19,10,52,255],[20,11,54,255],[22,11,57,255],[23,11,59,255],[25,11,62,255],[26,11,64,255],[28,12,67,255],[29,12,69,255],[31,12,71,255],[32,12,74,255],[34,11,76,255],[36,11,78,255],[38,11,80,255],[39,11,82,255],[41,11,84,255],[43,10,86,255],[45,10,88,255],[46,10,90,255],[48,10,92,255],[50,9,93,255],[52,9,95,255],[53,9,96,255],[55,9,97,255],[57,9,98,255],[59,9,100,255],[60,9,101,255],[62,9,102,255],[64,9,102,255],[65,9,103,255],[67,10,104,255],[69,10,105,255],[70,10,105,255],[72,11,106,255],[74,11,106,255],[75,12,107,255],[77,12,107,255],[79,13,108,255],[80,13,108,255],[82,14,108,255],[83,14,109,255],[85,15,109,255],[87,15,109,255],[88,16,109,255],[90,17,109,255],[91,17,110,255],[93,18,110,255],[95,18,110,255],[96,19,110,255],[98,20,110,255],[99,20,110,255],[101,21,110,255],[102,21,110,255],[104,22,110,255],[106,23,110,255],[107,23,110,255],[109,24,110,255],[110,24,110,255],[112,25,110,255],[114,25,109,255],[115,26,109,255],[117,27,109,255],[118,27,109,255],[120,28,109,255],[122,28,109,255],[123,29,108,255],[125,29,108,255],[126,30,108,255],[128,31,107,255],[129,31,107,255],[131,32,107,255],[133,32,106,255],[134,33,106,255],[136,33,106,255],[137,34,105,255],[139,34,105,255],[141,35,105,255],[142,36,104,255],[144,36,104,255],[145,37,103,255],[147,37,103,255],[149,38,102,255],[150,38,102,255],[152,39,101,255],[153,40,100,255],[155,40,100,255],[156,41,99,255],[158,41,99,255],[160,42,98,255],[161,43,97,255],[163,43,97,255],[164,44,96,255],[166,44,95,255],[167,45,95,255],[169,46,94,255],[171,46,93,255],[172,47,92,255],[174,48,91,255],[175,49,91,255],[177,49,90,255],[178,50,89,255],[180,51,88,255],[181,51,87,255],[183,52,86,255],[184,53,86,255],[186,54,85,255],[187,55,84,255],[189,55,83,255],[190,56,82,255],[191,57,81,255],[193,58,80,255],[194,59,79,255],[196,60,78,255],[197,61,77,255],[199,62,76,255],[200,62,75,255],[201,63,74,255],[203,64,73,255],[204,65,72,255],[205,66,71,255],[207,68,70,255],[208,69,68,255],[209,70,67,255],[210,71,66,255],[212,72,65,255],[213,73,64,255],[214,74,63,255],[215,75,62,255],[217,77,61,255],[218,78,59,255],[219,79,58,255],[220,80,57,255],[221,82,56,255],[222,83,55,255],[223,84,54,255],[224,86,52,255],[226,87,51,255],[227,88,50,255],[228,90,49,255],[229,91,48,255],[230,92,46,255],[230,94,45,255],[231,95,44,255],[232,97,43,255],[233,98,42,255],[234,100,40,255],[235,101,39,255],[236,103,38,255],[237,104,37,255],[237,106,35,255],[238,108,34,255],[239,109,33,255],[240,111,31,255],[240,112,30,255],[241,114,29,255],[242,116,28,255],[242,117,26,255],[243,119,25,255],[243,121,24,255],[244,122,22,255],[245,124,21,255],[245,126,20,255],[246,128,18,255],[246,129,17,255],[247,131,16,255],[247,133,14,255],[248,135,13,255],[248,136,12,255],[248,138,11,255],[249,140,9,255],[249,142,8,255],[249,144,8,255],[250,145,7,255],[250,147,6,255],[250,149,6,255],[250,151,6,255],[251,153,6,255],[251,155,6,255],[251,157,6,255],[251,158,7,255],[251,160,7,255],[251,162,8,255],[251,164,10,255],[251,166,11,255],[251,168,13,255],[251,170,14,255],[251,172,16,255],[251,174,18,255],[251,176,20,255],[251,177,22,255],[251,179,24,255],[251,181,26,255],[251,183,28,255],[251,185,30,255],[250,187,33,255],[250,189,35,255],[250,191,37,255],[250,193,40,255],[249,195,42,255],[249,197,44,255],[249,199,47,255],[248,201,49,255],[248,203,52,255],[248,205,55,255],[247,207,58,255],[247,209,60,255],[246,211,63,255],[246,213,66,255],[245,215,69,255],[245,217,72,255],[244,219,75,255],[244,220,79,255],[243,222,82,255],[243,224,86,255],[243,226,89,255],[242,228,93,255],[242,230,96,255],[241,232,100,255],[241,233,104,255],[241,235,108,255],[241,237,112,255],[241,238,116,255],[241,240,121,255],[241,242,125,255],[242,243,129,255],[242,244,133,255],[243,246,137,255],[244,247,141,255],[245,248,145,255],[246,250,149,255],[247,251,153,255],[249,252,157,255],[250,253,160,255],[252,254,164,255],[252,254,164,255]];for(var t=0;t<e.length;t++){const n=new Uint8ClampedArray(4);n.set(e[t]),e[t]=n}let n,a=!1;var r=0;return function(t,o){const l=o.getContext("2d");a||(n=null==l?void 0:l.createImageData(o.width,o.height),a=!0);for(var i=0;i<360;i++){let a=Math.floor(256*t[i]);(isNaN(a)||a<0)&&(a=0),a>256&&(a=1),n.data.set(e[a],4*((o.height-1-i)*o.width+r))}r=(r+1)%o.width,l.putImageData(n,o.width-r,0),l.putImageData(n,-r,0)}}();const a=tf.add(tf.linspace(0,7180,360),tf.tensor(1997.379408437619));async function r(e,t){return async function(){return navigator.getUserMedia||(navigator.mediaDevices?navigator.getUserMedia=navigator.mediaDevices.getUserMedia:navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),new Promise(((e,t)=>{navigator.getUserMedia?navigator.getUserMedia({audio:!0},(function(t){e(t)}),(function(e){t(`Could not access microphone - ${e}`)})):t("Could not access microphone - getUserMedia not available")}))}().then((n=>{console.log("Audio context sample rate = "+e.sampleRate);const a=e.createMediaStreamSource(n),r=e.sampleRate/16e3*1024;for(var o=4;o<r;o*=2);console.log("Buffer size = "+o);const l=e.createScriptProcessor(o,1,1);l.onaudioprocess=t;const i=e.createGain();return i.gain.setValueAtTime(0,e.currentTime),a.connect(l),l.connect(i),i.connect(e.destination),n}))}var o,l,i,s;function c({tfModel:t}){const[o,l]=e.useState(0),i=e.useRef(null);e.useEffect((()=>()=>{var e;null==(e=i.current)||e.getTracks().forEach((e=>e.stop()))}),[]);const s={"voicing-confidence":e.useRef(null),"estimated-pitch":e.useRef(null),canvas:e.useRef(null)},c=e.useCallback((e=>{t?function(e,t){const n=e.sampleRate%16e3!=0,a=e.sampleRate/16e3,r=e.getChannelData(0),o=new Float32Array(1024);for(var l=0;l<1024;l++)if(n){var i=Math.floor(l*a),s=i+1,c=l*a-i;o[l]=(1-c)*r[i]+c*r[s]}else o[l]=r[l*a];t({original:r,interpolate:n,multiplier:a,resampled:o})}(e.inputBuffer,(function({resampled:e}){tf.tidy((()=>{const t=tf.tensor(e.slice(0,1024)),r=tf.sub(t,tf.mean(t)),o=tf.tensor(tf.norm(r).dataSync()/Math.sqrt(1024)),l=tf.div(r,o).reshape([1,1024]),i=window.model.predict([l]).reshape([360]),c=i.max().dataSync()[0],u=i.argMax().dataSync()[0];s["voicing-confidence"].current&&(s["voicing-confidence"].current.innerHTML=c.toFixed(3));const d=Math.max(0,u-4),m=Math.min(360,u+5),p=i.slice([d],[m-d]),h=a.slice([d],[m-d]),f=tf.mul(p,h).dataSync().reduce(((e,t)=>e+t),0)/p.dataSync().reduce(((e,t)=>e+t),0),E=10*Math.pow(2,f/1200);for(var g=c>.5?`${E.toFixed(3)} Hz`:"&nbsp;no voice&nbsp&nbsp;",v=g.length,b=0;b<11-v;b++)g="&nbsp;"+g;s["estimated-pitch"].current&&(s["estimated-pitch"].current.innerHTML=g),s.canvas.current&&n(i.dataSync(),s.canvas.current)}))})):console.error("[process_microphone_buffer] tfModel hasn't been loaded")}),[t]),u=e.useCallback((async e=>r(e,c).then((t=>{i.current=t,l("running"===e.state?1:2)}))),[c]),d=e.useRef(null),[,m]=e.useState(!1),p=e.useCallback((async()=>d.current?d.current:async function(){return new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})}().then((e=>(d.current=e,m((e=>!e)),e)))),[]),h=e.useCallback(((e=!1)=>{var t,n;e?null==(t=d.current)||t.resume():null==(n=d.current)||n.suspend()}),[]),f=d.current;return e.useEffect((()=>{f&&(u(f),f.onstatechange=e=>{var t;switch(null==(t=null==e?void 0:e.target)?void 0:t.state){case"suspended":l(2);break;case"running":default:l(1)}})}),[f]),{domRefs:s,audioContextState:o,audioContext:f,onUserClickStartAudioContext:p,toggleAudioContextRunning:h}}function u(){const[t,n]=e.useState("https://marl.github.io/crepe/model/model.json"),{tfModel:a,initTF:r,tfModelState:l}=function(){const[t,n]=e.useState(o.DEFAULT),a=e.useRef(null),r=e.useCallback((async(e="https://marl.github.io/crepe/model/model.json")=>(n(o.LOADING),tf.loadModel(e).then((e=>{window.model=e,a.current=e,n(o.LOADED)})).catch((e=>{console.error("[initTF] error:",e),n(o.FAILED)})))),[]);return{tfModel:a.current,tfModelState:t,initTF:r}}(),{domRefs:i,audioContextState:s,audioContext:u,onUserClickStartAudioContext:d,toggleAudioContextRunning:m}=c({tfModel:a});return e.useLayoutEffect((()=>{i.canvas.current=document.querySelector("#activation")}),[]),e.createElement("div",{id:"container"},e.createElement("div",{id:"title"},"Convolutional REpresentation for Pitch Estimation"),e.createElement("div",{style:{textAlign:"center"}},e.createElement("canvas",{id:"activation",style:{maxWidth:"80vw"},width:"960",height:"360"})),e.createElement("div",{id:"output"},e.createElement("div",{style:{marginBottom:8,display:"flex"}},e.createElement("span",{style:{flexShrink:0,minWidth:"7em"}},"Model URL:"),e.createElement("input",{value:t,style:{width:"100%"},onChange:e=>{n(e.target.value.trim())}})," ",e.createElement("button",{disabled:!!a,onClick:()=>{r(t).then((()=>{d().then((e=>e.resume()))}))},style:{flexShrink:0}},"Load")),e.createElement("div",null,"Keras Model:"," ",e.createElement("span",null,l)),e.createElement("div",null,"Audio Status: "," ",e.createElement("span",{id:"status"},l!==o.LOADED?e.createElement(e.Fragment,null,"-"):0===s?e.createElement("span",{style:{color:"#25d625",cursor:"pointer"},onClick:()=>{d().then((e=>e.resume()))}},"Click here to start sample"):2===s?e.createElement(e.Fragment,null,"Suspended ",e.createElement("span",{style:{color:"#25d625",cursor:"pointer"},onClick:()=>{m(!0)}},"Click to Resume")):e.createElement(e.Fragment,null,"Running ",e.createElement("span",{style:{color:"#bff71a",cursor:"pointer"},onClick:()=>{m()}},"Click to Suspend")))),e.createElement("div",null,"Estimated Pitch: ",e.createElement("span",{ref:i["estimated-pitch"]}),e.createElement("br",null)),e.createElement("div",null,"Voicing Confidence: ",e.createElement("span",{ref:i["voicing-confidence"]}))),e.createElement("p",null,e.createElement("b",null,"NOTE"),": this tools is inspired by ",e.createElement("a",{href:"https://github.com/marl/crepe/",target:"_blank"},"mark/crepe"),", or say, it's just one migration/tunning of this project: ",e.createElement("a",{href:"https://marl.github.io/crepe/",target:"_blank"},"https://marl.github.io/crepe/"),", the orignal introduction displayed below ↓"),e.createElement("hr",null),e.createElement("h3",null,"Original Introduction"),e.createElement("div",{id:"info original"},e.createElement("p",null,"NOTE: This demo works most reliably in the latest versions of Chrome on Windows and MacOS. There is an issue where TensorFlow.js is not working properly on Linux versions of Chrome."),e.createElement("p",null,"A stripped-down model of CREPE is running on this browser, which has less than 3 percent of parameters. The performance of this online demo therefore may not be as good as reported in the ",e.createElement("a",{href:"https://arxiv.org/abs/1802.06182"},"paper"),", and it may make more octave errors than the full model. To run the model with the full capacity, check out the Git repo at ",e.createElement("a",{href:"https://github.com/marl/crepe"},"https://github.com/marl/crepe")," and follow the instructions in README.md."),e.createElement("p",null,"The model is trained on 16 kHz audio, and due to the imperfect resampling in the browser, this demo works best when the hardware sample rate is a multiple of 16000 Hz. Your sample rate is"," ",e.createElement("span",{id:"srate"},null==u?void 0:u.sampleRate)," Hz."),e.createElement("p",null,"For further details on this model, please refer to our paper:",e.createElement("br",null)," ",e.createElement("br",null),"    ",e.createElement("a",{href:"https://arxiv.org/abs/1802.06182"},"CREPE: A Convolutional Representation for Pitch Estimation"),e.createElement("br",null),"    Jong Wook Kim, Justin Salamon, Peter Li, Juan Pablo Bello",e.createElement("br",null),"    ",e.createElement("i",null,"Proceedings of the IEEE Conference on ICASSP, 2018."))))}(l=o||(o={})).DEFAULT="",l.LOADING="Loading Keras model...",l.LOADED="Model loading complete.",l.FAILED="Loading failed",(s=i||(i={}))[s.NOPIPELINE=0]="NOPIPELINE",s[s.RUNNING=1]="RUNNING",s[s.SUSPENDED=2]="SUSPENDED",s[s.FAILED=3]="FAILED",t.render(e.createElement(e.StrictMode,null,e.createElement(u,null)),document.getElementById("root"));
